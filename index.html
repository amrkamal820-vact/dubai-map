<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dubai Map – PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=4"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    /* شريط التعليمات يمين فوق عشان ما يتعارض مع زر التربو */
    .hud {
      position: fixed; right: 10px; top: 10px; z-index: 1000;
      background: rgba(0,0,0,.55); color: #fff; padding: 8px 10px; border-radius: 10px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; font-size: 14px;
    }

    /* d-pad أسفل يمين */
    .pad {
      position: fixed; right: 12px; bottom: 12px; z-index: 1001;
      display: grid; grid-template-columns: 56px 56px 56px; grid-template-rows: 56px 56px 56px;
      gap: 6px; user-select: none;
    }
    .btn {
      background: rgba(0,0,0,.45);
      color: #fff; border-radius: 14px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; backdrop-filter: blur(6px);
      touch-action: none;
    }
    .btn:active { transform: scale(.97); }
    .hidden { visibility: hidden; }

    /* زر التربو ثابت أعلى يسار */
    #turboFloat {
      position: fixed; left: 12px; top: 12px; z-index: 1002;
      background: rgba(255,213,0,.90); color: #000; font-weight: 700;
      border-radius: 12px; padding: 8px 12px; font-size: 16px; user-select: none;
    }
    #turboFloat:active { transform: scale(0.96); }

    @media (min-width: 900px) { .pad { right: 20px; bottom: 20px; } }
  </style>
</head>
<body>
  <div class="hud">السهم ↑↓←→ للتحرّك · كبّر/صغّر باللمس · ⚡ للجري</div>

  <!-- الخريطة -->
  <div id="map"></div>

  <!-- زر التربو أعلى يسار -->
  <button id="turboFloat">⚡ Turbo</button>

  <!-- d-pad أسفل يمين (بدون تربو في الوسط الآن) -->
  <div class="pad" id="pad">
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowUp">↑</div>
    <div class="hidden"></div>

    <div class="btn" data-k="ArrowLeft">←</div>
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowRight">→</div>

    <div class="hidden"></div>
    <div class="btn" data-k="ArrowDown">↓</div>
    <div class="hidden"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=4"></script>
  <script>
    /* Service Worker (مع نسخة للاستبدال القسري عند التحديث) */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?ver=4').then(r => r.update?.()).catch(console.warn);
      });
    }

    /* إعداد الخريطة */
    const dubai = [25.2048, 55.2708];
    const map = L.map('map', { zoomControl: true }).setView(dubai, 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    /* اللاعب */
    const playerIcon = L.icon({ iconUrl: 'player.png', iconSize: [44,44], iconAnchor: [22,22] });
    const player = L.marker(dubai, { draggable:false, icon: playerIcon }).addTo(map);

    /* موقع محفوظ */
    let lat = dubai[0], lng = dubai[1];
    try {
      const saved = JSON.parse(localStorage.getItem('playerPos'));
      if (Array.isArray(saved)) { lat = saved[0]; lng = saved[1]; player.setLatLng(saved); map.setView(saved); }
    } catch {}

    function move(dx, dy) {
      lat += dy; lng += dx;
      const p = [lat, lng];
      player.setLatLng(p);
      map.panTo(p, { animate: false });
      localStorage.setItem('playerPos', JSON.stringify(p));
    }

    /* سرعة الحركة */
    const WALK_SPEED_MPS   = 40;  // أسرع
    const SPRINT_SPEED_MPS = 80;  // جري
    const METERS_PER_DEG_LAT = 111000;

    /* الحالة */
    let held = { up:false, down:false, left:false, right:false, sprint:false };

    /* قلبت الاتجاهات عشان كانت معكوسة عندك */
    // لاحظ: dx للشرق/الغرب (طوليًا على الخريطة)، dy للشمال/الجنوب
    // هنا خلّينا up يقلّل lat (يروح لفوق)، left يزيد/ينقص حسب المطلوب.
    // بناءً على ملاحظتك: نعكس المحاور كالتالي:
    const INVERT_VERTICAL = true;
    const INVERT_HORIZONTAL = true;

    /* كيبورد */
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp')    held.up = true;
      if (e.key === 'ArrowDown')  held.down = true;
      if (e.key === 'ArrowLeft')  held.left = true;
      if (e.key === 'ArrowRight') held.right = true;
      if (e.key === 'Shift')      held.sprint = true;
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp')    held.up = false;
      if (e.key === 'ArrowDown')  held.down = false;
      if (e.key === 'ArrowLeft')  held.left = false;
      if (e.key === 'ArrowRight') held.right = false;
      if (e.key === 'Shift')      held.sprint = false;
    });

    /* لمس (d-pad) */
    const pad = document.getElementById('pad');
    function setHeldFromTarget(t, val) {
      const k = t.getAttribute('data-k'); if (!k) return;
      if (k === 'ArrowUp')    held.up    = val;
      if (k === 'ArrowDown')  held.down  = val;
      if (k === 'ArrowLeft')  held.left  = val;
      if (k === 'ArrowRight') held.right = val;
    }
    pad.addEventListener('pointerdown', (e) => {
      const t = e.target.closest('.btn'); if (!t) return;
      setHeldFromTarget(t, true);
      t.setPointerCapture?.(e.pointerId);
    });
    pad.addEventListener('pointerup',   (e) => { const t = e.target.closest('.btn'); if (!t) return; setHeldFromTarget(t, false); });
    pad.addEventListener('pointercancel',() => { held = {up:false,down:false,left:false,right:false,sprint:false}; });

    /* زر التربو أعلى يسار */
    const turbo = document.getElementById('turboFloat');
    function setSprint(val){ held.sprint = val; }
    turbo.addEventListener('pointerdown', e => { setSprint(true);  turbo.setPointerCapture?.(e.pointerId); });
    turbo.addEventListener('pointerup',   () => setSprint(false));
    turbo.addEventListener('pointercancel',() => setSprint(false));
    turbo.addEventListener('pointerleave',() => setSprint(false));

    /* حلقة الحركة (مع عكس الاتجاهات) */
    let last = performance.now();
    function tick(now) {
      const dt = (now - last) / 1000; last = now;
      const speedMps = held.sprint ? SPRINT_SPEED_MPS : WALK_SPEED_MPS;
      const stepDeg  = (speedMps / METERS_PER_DEG_LAT) * dt;

      let dx = 0, dy = 0;

      // لو مقلوب رأسيًا: فوق يزيد dy بالسالب
      if (held.up)    dy += (INVERT_VERTICAL   ? -stepDeg : +stepDeg);
      if (held.down)  dy += (INVERT_VERTICAL   ? +stepDeg : -stepDeg);
      // لو مقلوب أفقيًا: اليسار يمشي للغرب لكن بنعكس
      if (held.left)  dx += (INVERT_HORIZONTAL ? +stepDeg : -stepDeg);
      if (held.right) dx += (INVERT_HORIZONTAL ? -stepDeg : +stepDeg);

      if (dx || dy) move(dx, dy);
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    /* أمثلة نقاط */
    const areas = [
      { name: 'Downtown Dubai', pos: [25.1972, 55.2744] },
      { name: 'Dubai Marina',   pos: [25.0800, 55.1390] },
      { name: 'Deira',          pos: [25.2711, 55.3075] },
      { name: 'Jumeirah',       pos: [25.2028, 55.2397] },
    ];
    areas.forEach(a => L.circleMarker(a.pos, { radius: 6 }).addTo(map).bindPopup(a.name));
  </script>
</body>
</html>
