<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dubai Map â€“ PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=8"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud {
      position: fixed; right: 10px; top: 10px; z-index: 1000;
      background: rgba(0,0,0,.55); color: #fff; padding: 8px 10px; border-radius: 10px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; font-size: 14px;
    }

    .pad {
      position: fixed; right: 12px; bottom: 12px; z-index: 1001;
      display: grid; grid-template-columns: 56px 56px 56px; grid-template-rows: 56px 56px 56px;
      gap: 6px; user-select: none;
    }
    .btn {
      background: rgba(0,0,0,.45);
      color: #fff; border-radius: 14px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; backdrop-filter: blur(6px);
      touch-action: none;
    }
    .btn:active { transform: scale(.97); }
    .hidden { visibility: hidden; }

    /* Ø²Ø± Turbo (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù) Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± */
    #turboToggle {
      position: fixed; left: 12px; top: 12px; z-index: 1002;
      border: 0; border-radius: 12px; padding: 8px 12px; font-size: 16px; font-weight: 700;
      color: #000; background: rgba(255,213,0,.95); user-select: none;
    }
    #turboToggle:active { transform: scale(.96); }

    /* Ø³ØªØ§ÙŠÙ„ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .poi-popup .leaflet-popup-content {
      margin: 8px 10px; font-size: 14px; line-height: 1.5; direction: rtl;
    }
    .poi-popup .leaflet-popup-tip,
    .poi-popup .leaflet-popup-content-wrapper {
      background: #111827; color: #fff; border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }

    @media (min-width: 900px) { .pad { right: 20px; bottom: 20px; } }
  </style>
</head>
<body>
  <div class="hud">â†‘â†“â†â†’ Ù„Ù„ØªØ­Ø±Ù‘Ùƒ Â· ÙƒØ¨Ù‘Ø±/ØµØºÙ‘Ø± Ø¨Ø§Ù„Ù„Ù…Ø³ Â· âš¡ Ù„Ù„ØªÙŠØ±Ø¨Ùˆ (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù)</div>

  <div id="map"></div>

  <!-- Ø²Ø± Toggle Turbo -->
  <button id="turboToggle">âš¡ Turbo OFF</button>

  <!-- d-pad Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
  <div class="pad" id="pad">
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowUp">â†‘</div>
    <div class="hidden"></div>

    <div class="btn" data-k="ArrowLeft">â†</div>
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowRight">â†’</div>

    <div class="hidden"></div>
    <div class="btn" data-k="ArrowDown">â†“</div>
    <div class="hidden"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=8"></script>
  <script>
    // Ø£Ø¬Ø¨Ø± ØªØ­Ø¯ÙŠØ« SW Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙˆØ±Ù‹Ø§
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?ver=8').then(r => r.update?.()).catch(console.warn);
      });
    }

    // Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const dubai = [25.2048, 55.2708];
    const map = L.map('map', { zoomControl: true }).setView(dubai, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    // Ø§Ù„Ù„Ø§Ø¹Ø¨
    const playerIcon = L.icon({ iconUrl: 'player.png', iconSize: [44,44], iconAnchor: [22,22] });
    const player = L.marker(dubai, { draggable:false, icon: playerIcon }).addTo(map);

    // Ù…ÙˆÙ‚Ø¹ Ù…Ø­ÙÙˆØ¸
    let lat = dubai[0], lng = dubai[1];
    try {
      const saved = JSON.parse(localStorage.getItem('playerPos'));
      if (Array.isArray(saved)) { lat = saved[0]; lng = saved[1]; player.setLatLng(saved); map.setView(saved); }
    } catch {}

    function move(dx, dy) {
      // dx â†’ LNG (ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±) ØŒ dy â†’ LAT (ÙÙˆÙ‚/ØªØ­Øª)
      lng += dx;
      lat += dy;
      const p = [lat, lng];
      player.setLatLng(p);
      map.panTo(p, { animate: false });
      localStorage.setItem('playerPos', JSON.stringify(p));
    }

    // Ø³Ø±Ø¹Ø§Øª
    const WALK_SPEED_MPS   = 40;    // Ù…Ø´ÙŠ Ø³Ø±ÙŠØ¹
    const SPRINT_SPEED_MPS = 180;   // Turbo Ø³Ø±ÙŠØ¹
    const METERS_PER_DEG_LAT = 111000;

    // Ø§Ù„Ø­Ø§Ù„Ø© + Turbo Toggle
    let held = { up:false, down:false, left:false, right:false, sprint:false };
    const turboBtn = document.getElementById('turboToggle');
    function renderTurbo(){
      turboBtn.textContent = held.sprint ? 'âš¡ Turbo ON' : 'âš¡ Turbo OFF';
      turboBtn.style.background = held.sprint ? 'rgba(255,80,0,.95)' : 'rgba(255,213,0,.95)';
    }
    turboBtn.addEventListener('click', () => { held.sprint = !held.sprint; renderTurbo(); });
    renderTurbo();

    // ÙƒÙŠØ¨ÙˆØ±Ø¯
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp')    held.up = true;
      if (e.key === 'ArrowDown')  held.down = true;
      if (e.key === 'ArrowLeft')  held.left = true;
      if (e.key === 'ArrowRight') held.right = true;
      if (e.key === 'Shift')      { held.sprint = true; renderTurbo(); }
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp')    held.up = false;
      if (e.key === 'ArrowDown')  held.down = false;
      if (e.key === 'ArrowLeft')  held.left = false;
      if (e.key === 'ArrowRight') held.right = false;
      if (e.key === 'Shift')      { held.sprint = false; renderTurbo(); }
    });

    // Ù„Ù…Ø³ (d-pad)
    const pad = document.getElementById('pad');
    function setHeldFromTarget(t, val) {
      const k = t.getAttribute('data-k'); if (!k) return;
      if (k === 'ArrowUp')    held.up    = val;
      if (k === 'ArrowDown')  held.down  = val;
      if (k === 'ArrowLeft')  held.left  = val;
      if (k === 'ArrowRight') held.right = val;
    }
    pad.addEventListener('pointerdown', (e) => {
      const t = e.target.closest('.btn'); if (!t) return;
      setHeldFromTarget(t, true);
      t.setPointerCapture?.(e.pointerId);
    });
    pad.addEventListener('pointerup',   (e) => { const t = e.target.closest('.btn'); if (!t) return; setHeldFromTarget(t, false); });
    pad.addEventListener('pointercancel',() => { held = {up:false,down:false,left:false,right:false,sprint:held.sprint}; });

    // === Ù†Ù‚Ø§Ø· Ø§Ù‡ØªÙ…Ø§Ù… (POIs) + ÙÙ‚Ø§Ø¹Ø© Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ ===
    const pois = [
      { name: 'Dubai Mall',     pos: [25.1975, 55.2790],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Mall</b> ğŸ›ï¸' },
      { name: 'Burj Khalifa',   pos: [25.1972, 55.2744],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Burj Khalifa</b> ğŸ—¼' },
      { name: 'Marina Walk',    pos: [25.0797, 55.1400],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Marina Walk</b> ğŸŒŠ' },
      { name: 'DXB T3',         pos: [25.2487, 55.3526],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Intâ€™l Airport â€“ T3</b> âœˆï¸' },
      { name: 'Deira City Ctr', pos: [25.2532, 55.3349],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Deira City Centre</b> ğŸ›’' },
    ];

    // Ù…ÙØ¹Ù„Ù‘ÙÙ…Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    pois.forEach(p => L.circleMarker(p.pos, { radius: 6 }).addTo(map).bindPopup(p.name));

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§ÙØ© (Haversine) Ø¨Ø§Ù„Ù…ØªØ±
    function distMeters(aLat,aLng,bLat,bLng){
      const R=6371000;
      const toRad=(d)=>d*Math.PI/180;
      const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const A=s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(A)));
    }

    let activePOI = null;   // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­ (Ø¥Ù† ÙˆØ¬Ø¯)
    const NEAR = 150;       // Ø¹ØªØ¨Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„Ù…ØªØ± Ù„ÙØªØ­ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©

    function updatePOIPopup() {
      let found = null;
      for (const p of pois) {
        if (distMeters(lat, lng, p.pos[0], p.pos[1]) <= NEAR) { found = p; break; }
      }
      if (found && activePOI !== found.name) {
        activePOI = found.name;
        player.bindPopup(found.msg, {
          offset: [0, -28],
          autoPan: false,
          closeButton: false,
          className: 'poi-popup'
        }).openPopup();
      } else if (!found && activePOI) {
        player.closePopup();
        activePOI = null;
      }
    }

    // Ø­Ø±ÙƒØ© Ø³Ù„Ø³Ø© (Ø§ØªØ¬Ø§Ù‡Ø§Øª ØµØ­ÙŠØ­Ø©: â†‘ ÙŠØ²ÙŠØ¯ LATØŒ â†’ ÙŠØ²ÙŠØ¯ LNG)
    let last = performance.now();
    function tick(now) {
      const dt = (now - last) / 1000; last = now;
      const speedMps = held.sprint ? SPRINT_SPEED_MPS : WALK_SPEED_MPS;
      const stepDeg  = (speedMps / METERS_PER_DEG_LAT) * dt;

      const vx = (held.right ? 1 : 0) - (held.left ? 1 : 0); // ÙŠÙ…ÙŠÙ† Ù…ÙˆØ¬Ø¨
      const vy = (held.up    ? 1 : 0) - (held.down ? 1 : 0); // ÙÙˆÙ‚ Ù…ÙˆØ¬Ø¨

      const dx = vx * stepDeg;
      const dy = vy * stepDeg;

      if (dx || dy) move(dx, dy);

      // ÙØ­Øµ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ù… ÙˆÙØªØ­/ØºÙ„Ù‚ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
      updatePOIPopup();

      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ
    updatePOIPopup();
  </script>
</body>
</html>
