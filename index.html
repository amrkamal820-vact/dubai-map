<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dubai Map â€“ PWA</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=16"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud {
      position: fixed; right: 10px; top: 10px; z-index: 1000;
      background: rgba(0,0,0,.55); color: #fff; padding: 8px 10px; border-radius: 10px;
      font: 14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      pointer-events: none; /* Ù…Ø§ ØªÙ…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    }

    #turboToggle{
      position:fixed; left:12px; top:12px; z-index:1002;
      border:0; border-radius:12px; padding:8px 12px; font-size:16px; font-weight:700;
      color:#000; background:rgba(255,213,0,.95); user-select:none;
    }
    #turboToggle:active{ transform:scale(.96); }

    #gpsBtn{
      position:fixed; left:12px; bottom:12px; z-index:1002;
      width:56px; height:56px; border-radius:50%; border:0; background:rgba(0,0,0,.55);
      color:#fff; font-size:22px; font-weight:700; display:grid; place-items:center; user-select:none; backdrop-filter:blur(6px);
    }
    #gpsBtn:active{ transform:scale(.96); }

    .fab {
      position: fixed; right: 12px; z-index: 1002; width: 56px; height: 56px;
      border-radius: 16px; border: 0; display: grid; place-items: center; color:#fff;
      background: #111827cc; backdrop-filter: blur(6px); font-size: 22px; user-select: none;
    }
    #openProfile { bottom: 80px; }
    #openChat    { bottom: 12px; }

    /* d-pad: Ù†Ø®Ù„ÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø´ÙØ§ÙØ© Ù„Ù„Ù…Ø§ÙˆØ³ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø³Ø­Ø¨ ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    .pad {
      position: fixed; right: 84px; bottom: 12px; z-index: 1001;
      display: grid; grid-template-columns: 56px 56px 56px; grid-template-rows: 56px 56px 56px;
      gap: 6px; user-select: none;
      pointer-events: none; /* Ø§Ù„Ù…Ù‡Ù… */
    }
    .btn {
      background: rgba(0,0,0,.45); color:#fff; border-radius:14px;
      display:flex; align-items:center; justify-content:center; font-size:18px; backdrop-filter: blur(6px);
      touch-action:none;
      pointer-events: auto; /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù†ÙØ³Ù‡Ø§ Ù„Ø³Ù‡ Ø¨ØªØ§Ø®Ø¯ Ø§Ù„Ù„Ù…Ø³ */
    }
    .btn:active{ transform: scale(.97); }
    .hidden{ visibility:hidden; }

    .poi-popup .leaflet-popup-content{ margin:8px 10px; font-size:14px; line-height:1.5; direction:rtl; }
    .poi-popup .leaflet-popup-tip, .poi-popup .leaflet-popup-content-wrapper{
      background:#111827; color:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
    }

    .avatar-icon {
      width:44px; height:44px; border-radius:50%; overflow:hidden; border:2px solid #0ea5e9;
      box-shadow:0 2px 10px rgba(0,0,0,.25);
      background:#fff center/cover no-repeat;
    }

    /* Panels (Ù…Ø®ØªØµØ± â€” Ù†ÙØ³ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ Ù…Ø³Ø¨Ù‚Ù‹Ø§) */
    .panel { position: fixed; inset: auto 0 0 0; top: 30%; background: rgba(17,24,39,.98); color:#fff;
      border-radius: 16px 16px 0 0; z-index: 1003; transform: translateY(100%); transition: transform .25s ease;
      padding:14px; font:14px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; max-height: 70%; overflow:auto; }
    .panel.open { transform: translateY(0); }
    .panel .closeBtn{ position:absolute; top:8px; left:8px; width:34px; height:34px; border:0; border-radius:10px;
      background:#0b1220; color:#fff; font-size:18px; display:grid; place-items:center; border:1px solid #25324a; }
  </style>
</head>
<body>
  <div class="hud">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„ØªØ­Ø±ÙŠÙƒ Â· Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„ØªÙƒØ¨ÙŠØ± Â· â†‘â†“â†â†’ Ù„Ù„ØªØ­Ø±Ù‘Ùƒ Â· âš¡ Turbo Â· ğŸ§­ GPS</div>

  <div id="map"></div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø«Ø§Ø¨ØªØ© -->
  <button id="turboToggle">âš¡ Turbo OFF</button>
  <button id="gpsBtn" title="Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ§­</button>
  <button id="openProfile" class="fab" title="Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„">ğŸ‘¤</button>
  <button id="openChat" class="fab" title="Ø§Ù„Ø´Ø§Øª">ğŸ’¬</button>

  <!-- d-pad -->
  <div class="pad" id="pad">
    <div class="hidden"></div><div class="btn" data-k="ArrowUp">â†‘</div><div class="hidden"></div>
    <div class="btn" data-k="ArrowLeft">â†</div><div class="hidden"></div><div class="btn" data-k="ArrowRight">â†’</div>
    <div class="hidden"></div><div class="btn" data-k="ArrowDown">â†“</div><div class="hidden"></div>
  </div>

  <!-- Panels (Ù…Ø®ØªØµØ±Ø© â€“ Ù†ÙØ³ Ø§Ù„Ù„ÙŠ Ø¨Ø¹ØªÙ‘Ù‡ÙˆÙ„Ùƒ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡) -->
  <div id="profilePanel" class="panel" aria-hidden="true">
    <button id="closeProfile" class="closeBtn" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
    <div class="title">ğŸ‘¤ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ & Ø§Ù„Ù…Ù‚ØªÙ†ÙŠØ§Øª</div>
    <div class="row">
      <div class="field"><label>Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><select id="playerSelect"></select></div>
      <button id="addPlayer" class="btnSec">â• Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      <button id="delPlayer" class="btnSec">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨</button>
    </div>
    <div class="row">
      <div class="field" style="min-width:220px"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨"></div>
      <div class="field" style="min-width:220px"><label>Ø§Ù„Ù†Ø¨Ø°Ø©</label><input type="text" id="pBio" placeholder="Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø©"></div>
    </div>
    <div class="row">
      <div class="field"><label>Ø§Ù„ØµÙˆØ±Ø© (Avatar)</label><input type="file" id="pPhoto" accept="image/*"></div>
      <button id="saveProfile" class="btnPri">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
    <div class="title">ğŸ§º Ø§Ù„Ù…Ù‚ØªÙ†ÙŠØ§Øª</div>
    <div class="row">
      <div class="field"><label>Ø£ÙŠÙ‚ÙˆÙ†Ø©</label><input type="text" id="invEmoji" placeholder="ğŸš— / ğŸ“±" maxlength="3" style="width:100px"></div>
      <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="invName" placeholder="Ø¹Ø±Ø¨ÙŠØ© / Ù…ÙˆØ¨Ø§ÙŠÙ„"></div>
      <button id="addItem" class="btnSec">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <div id="invList" class="row"></div>
  </div>

  <div id="chatPanel" class="panel" aria-hidden="true">
    <button id="closeChat" class="closeBtn" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
    <div class="title">ğŸ’¬ Ø§Ù„Ø´Ø§Øª</div>
    <div class="row">
      <div class="field"><label>Ø£Ù†Ø§:</label><select id="chatFrom"></select></div>
      <div class="field"><label>Ø¥Ù„Ù‰:</label><select id="chatTo"></select></div>
    </div>
    <div id="chatList" class="chatList"></div>
    <div class="chatInput"><input id="chatMsg" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."><button id="sendMsg" class="btnPri">Ø¥Ø±Ø³Ø§Ù„</button></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=16"></script>
  <script>
    /* ===== Service Worker ===== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?ver=16').catch(console.warn);
      });
    }

    /* ===== Map ===== */
    const dubai = [25.2048, 55.2708];
    const map = L.map('map', {
      zoomControl: true,
      dragging: true,
      scrollWheelZoom: true,   // Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³
      tap: false               // ÙŠÙ…Ù†Ø¹ ØªØ¹Ø§Ø±Ø¶ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ù‡ÙˆØ§ØªÙ
    }).setView(dubai, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);
    map.dragging.enable(); map.scrollWheelZoom.enable();

    /* ===== Store (Ù…Ø®ØªØµØ±) ===== */
    const store = {
      get profiles(){ return JSON.parse(localStorage.getItem('profiles')||'[]'); },
      set profiles(v){ localStorage.setItem('profiles', JSON.stringify(v)); },
      get currentId(){ return localStorage.getItem('currentPlayerId'); },
      set currentId(v){ localStorage.setItem('currentPlayerId', v); },
      get chats(){ return JSON.parse(localStorage.getItem('chats')||'[]'); },
      set chats(v){ localStorage.setItem('chats', JSON.stringify(v)); }
    };
    if (store.profiles.length === 0) {
      const id = 'p-' + Date.now();
      /* Ù…Ù‡Ù…: Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ØµÙˆØ±Ø© avatar.jpg */
      store.profiles = [{ id, name:'Player 1', bio:'Ready!', photo:'avatar.jpg', inventory:[] }];
      store.currentId = id;
    } else {
      // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… avatar.jpg
      const arr = store.profiles;
      arr.forEach(p=>{ if(!p.photo) p.photo='avatar.jpg'; });
      store.profiles = arr;
    }
    function currentProfile(){ const arr=store.profiles; return arr.find(p=>p.id===store.currentId) || arr[0]; }

    /* ===== Player marker (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±ØªÙƒ) ===== */
    function avatarIcon(url){
      return L.divIcon({ html:`<div class="avatar-icon" style="background-image:url('${url.replace(/'/g,"&#39;")}')"></div>`, className:'', iconSize:[44,44], iconAnchor:[22,22] });
    }
    let lat=dubai[0], lng=dubai[1], tLat=lat, tLng=lng;
    let player = L.marker([lat,lng], { icon: avatarIcon(currentProfile().photo) }).addTo(map);

    try{ const saved=JSON.parse(localStorage.getItem('playerPos')); if(Array.isArray(saved)){ lat=saved[0]; lng=saved[1]; tLat=lat; tLng=lng; player.setLatLng(saved); map.setView(saved);} }catch{}

    let saveAccum=0; function savePos(dt){ saveAccum+=dt; if(saveAccum>=0.5){ localStorage.setItem('playerPos', JSON.stringify([lat,lng])); saveAccum=0; } }
    function nudgeTarget(dx,dy){ tLng+=dx; tLat+=dy; }
    const WALK_SPEED_MPS=40, SPRINT_SPEED_MPS=180, METERS_PER_DEG_LAT=111000;
    const SMOOTH=0.18, PAN_OPTS={ animate:true, duration:0.15, easeLinearity:0.25 };
    let held={up:false,down:false,left:false,right:false,sprint:false};

    const turboBtn = document.getElementById('turboToggle');
    function renderTurbo(){ turboBtn.textContent = held.sprint ? 'âš¡ Turbo ON' : 'âš¡ Turbo OFF';
      turboBtn.style.background = held.sprint ? 'rgba(255,80,0,.95)' : 'rgba(255,213,0,.95)'; }
    turboBtn.addEventListener('click', ()=>{ held.sprint=!held.sprint; renderTurbo(); }); renderTurbo();

    window.addEventListener('keydown', (e)=>{
      if (e.key==='ArrowUp') held.up=true;
      if (e.key==='ArrowDown') held.down=true;
      if (e.key==='ArrowLeft') held.left=true;
      if (e.key==='ArrowRight') held.right=true;
      if (e.key==='Shift'){ held.sprint=true; renderTurbo(); }
      if (e.key==='Escape') closePanels();
    });
    window.addEventListener('keyup', (e)=>{
      if (e.key==='ArrowUp') held.up=false;
      if (e.key==='ArrowDown') held.down=false;
      if (e.key==='ArrowLeft') held.left=false;
      if (e.key==='ArrowRight') held.right=false;
      if (e.key==='Shift'){ held.sprint=false; renderTurbo(); }
    });

    const pad=document.getElementById('pad');
    function setHeldFromTarget(t,val){ const k=t.getAttribute('data-k'); if(!k)return;
      if(k==='ArrowUp')held.up=val; if(k==='ArrowDown')held.down=val; if(k==='ArrowLeft')held.left=val; if(k==='ArrowRight')held.right=val; }
    pad.addEventListener('pointerdown',e=>{ const t=e.target.closest('.btn'); if(!t)return; setHeldFromTarget(t,true); t.setPointerCapture?.(e.pointerId); });
    pad.addEventListener('pointerup',e=>{ const t=e.target.closest('.btn'); if(!t)return; setHeldFromTarget(t,false); });
    pad.addEventListener('pointercancel',()=>{ held={up:false,down:false,left:false,right:false,sprint:held.sprint}; });

    /* ===== Landmarks (Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©) ===== */
    function ico(emoji){ return L.divIcon({ html:`<div class="avatar-icon" style="border-color:#222;background:#fff;font-size:20px;display:grid;place-items:center;"><span style="filter:grayscale(0);">${emoji}</span></div>`, className:'', iconSize:[44,44], iconAnchor:[22,22] }); }
    const gLandmarks = L.layerGroup().addTo(map);
    const landmarks = [
      {name:'Burj Khalifa',        pos:[25.1972,55.2744], emoji:'ğŸ—¼', info:'Ø¨Ø±Ø¬ Ø®Ù„ÙŠÙØ©'},
      {name:'Burj Al Arab',        pos:[25.1412,55.1852], emoji:'ğŸ¨', info:'Ø¨Ø±Ø¬ Ø§Ù„Ø¹Ø±Ø¨'},
      {name:'Museum of the Future',pos:[25.2269,55.2865], emoji:'ğŸ›ï¸', info:'Ù…ØªØ­Ù Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„'},
      {name:'Dubai Frame',         pos:[25.2343,55.3001], emoji:'ğŸ–¼ï¸', info:'Ø¨Ø±ÙˆØ§Ø² Ø¯Ø¨ÙŠ'},
      {name:'Palm Jumeirah',       pos:[25.1122,55.1389], emoji:'ğŸŒ´', info:'Ù†Ø®Ù„Ø© Ø¬Ù…ÙŠØ±Ø§'}
    ];
    landmarks.forEach(p=>{
      const m=L.marker(p.pos,{icon:ico(p.emoji)}).addTo(gLandmarks);
      m.bindPopup(`<b>${p.name}</b><br>${p.info||''}`);
    });
    L.control.layers(null, { "ğŸ›ï¸ Landmarks": gLandmarks }, { collapsed:true, position:'topright' }).addTo(map);

    /* ===== Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ù… (ÙÙ‚Ø§Ø¹Ø© ÙÙˆÙ‚ Ø§Ù„Ù„Ø§Ø¹Ø¨) ===== */
    function distMeters(aLat,aLng,bLat,bLng){ const R=6371000,toRad=d=>d*Math.PI/180; const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2); const A=s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2; return 2*R*Math.asin(Math.min(1,Math.sqrt(A))); }
    const NEAR=250; let activePOI=null, popupTimer=null; const cooldown={};
    function ding(){ try{ const c=new (window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(),g=c.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.001; o.connect(g).connect(c.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.2,c.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.18); o.stop(c.currentTime+0.2);}catch(e){} }
    const corePOIs = [
      { name:'Dubai Mall', pos:[25.1975,55.2790], msg:'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Mall</b> ğŸ›ï¸' },
      { name:'Burj Khalifa', pos:[25.1972,55.2744], msg:'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Burj Khalifa</b> ğŸ—¼' },
      { name:'Burj Al Arab', pos:[25.1412,55.1852], msg:'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Burj Al Arab</b> ğŸ¨' },
    ];
    function openPOI(p){ activePOI=p.name; player.bindPopup(p.msg,{offset:[0,-28],autoPan:false,closeButton:false,className:'poi-popup'}).openPopup(); ding();
      if(popupTimer)clearTimeout(popupTimer); popupTimer=setTimeout(()=>{ player.closePopup(); activePOI=null; cooldown[p.name]=performance.now()+3000; },4000); }
    function updatePOIPopup(){ let found=null; for(const p of corePOIs){ if(distMeters(lat,lng,p.pos[0],p.pos[1])<=NEAR){ found=p; break; } }
      const now=performance.now(); if(found){ const cd=cooldown[found.name]||0; if(!activePOI && now>cd) openPOI(found); }
      else{ if(activePOI){ player.closePopup(); activePOI=null; } if(popupTimer){ clearTimeout(popupTimer); popupTimer=null; } } }

    /* ===== GPS ===== */
    document.getElementById('gpsBtn').addEventListener('click', ()=>{
      if(!('geolocation' in navigator)){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS'); return; }
      const btn=document.getElementById('gpsBtn'); btn.disabled=true; btn.style.opacity=.7;
      navigator.geolocation.getCurrentPosition(pos=>{
        btn.disabled=false; btn.style.opacity=1;
        const { latitude, longitude, accuracy } = pos.coords;
        tLat=latitude; tLng=longitude; lat=latitude; lng=longitude;
        player.setLatLng([lat,lng]); map.setView([lat,lng], Math.max(map.getZoom(),16), {animate:true,duration:.4});
        const circle=L.circle([lat,lng],{radius:Math.max(accuracy,25),color:'#3b82f6',fillColor:'#60a5fa',fillOpacity:.2,weight:1}).addTo(map);
        setTimeout(()=>map.removeLayer(circle),4000);
      }, err=>{ btn.disabled=false; btn.style.opacity=1; alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: '+(err.message||err.code)); }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    });

    /* ===== Game loop (smooth easing) ===== */
    let last=performance.now();
    function tick(now){
      const dt=(now-last)/1000; last=now;
      const speedMps = held.sprint ? SPRINT_SPEED_MPS : WALK_SPEED_MPS;
      const stepDeg  = (speedMps / METERS_PER_DEG_LAT) * dt;
      const vx=(held.right?1:0)-(held.left?1:0);
      const vy=(held.up?1:0)-(held.down?1:0);
      if(vx||vy) nudgeTarget(vx*stepDeg, vy*stepDeg);
      const dLat=tLat-lat, dLng=tLng-lng; lat+=dLat*SMOOTH; lng+=dLng*SMOOTH;
      const p=[lat,lng]; player.setLatLng(p); map.panTo(p, PAN_OPTS);
      savePos(dt); updatePOIPopup(); requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    /* ===== Panels & Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ ===== */
    const profilePanel=document.getElementById('profilePanel');
    const chatPanel=document.getElementById('chatPanel');
    function openPanel(p){ p.classList.add('open'); }
    function closePanel(p){ p.classList.remove('open'); }
    function closePanels(){ closePanel(profilePanel); closePanel(chatPanel); }
    document.getElementById('closeProfile').addEventListener('click', ()=>closePanel(profilePanel));
    document.getElementById('closeChat').addEventListener('click', ()=>closePanel(chatPanel));
    document.getElementById('openProfile').addEventListener('click', ()=>{ const o=profilePanel.classList.contains('open'); closePanels(); if(!o) openPanel(profilePanel); });
    document.getElementById('openChat').addEventListener('click', ()=>{ const o=chatPanel.classList.contains('open'); closePanels(); if(!o) openPanel(chatPanel); });
    map.on('click', closePanels); map.on('dragstart', closePanels);
    document.getElementById('map').addEventListener('pointerdown', closePanels);

    /* ===== Ø¨Ø§Ù‚ÙŠ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„/Ø§Ù„Ø´Ø§Øª Ù†ÙØ³Ù‡Ø§ (Ù…Ø®ØªØµØ±Ø© Ù‡Ù†Ø§) ===== */
    const playerSelect=document.getElementById('playerSelect');
    const pName=document.getElementById('pName'); const pBio=document.getElementById('pBio'); const pPhoto=document.getElementById('pPhoto');
    const invList=document.getElementById('invList');
    function refreshPlayerSelect(){ const list=store.profiles; playerSelect.innerHTML=''; list.forEach(p=>{const o=document.createElement('option'); o.value=p.id; o.textContent=p.name||'Ù„Ø§Ø¹Ø¨'; playerSelect.appendChild(o);});
      if(!store.currentId||!list.find(p=>p.id===store.currentId)) store.currentId=list[0].id; playerSelect.value=store.currentId; loadCurrentProfile(); }
    function loadCurrentProfile(){ const p=currentProfile(); pName.value=p.name||''; pBio.value=p.bio||''; renderInventory(); player.setIcon(avatarIcon(p.photo||'avatar.jpg')); }
    playerSelect.addEventListener('change', ()=>{ store.currentId=playerSelect.value; loadCurrentProfile(); });
    document.getElementById('addPlayer').addEventListener('click', ()=>{ const id='p-'+Date.now(); const arr=store.profiles; arr.push({id,name:'New Player',bio:'',photo:'avatar.jpg',inventory:[]}); store.profiles=arr; store.currentId=id; refreshPlayerSelect(); });
    document.getElementById('delPlayer').addEventListener('click', ()=>{ const arr=store.profiles; if(arr.length<=1){alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨');return;} const i=arr.findIndex(p=>p.id===store.currentId); if(i>=0){arr.splice(i,1); store.profiles=arr; store.currentId=arr[0].id; refreshPlayerSelect();} });
    document.getElementById('saveProfile').addEventListener('click', ()=>{ const arr=store.profiles; const p=arr.find(x=>x.id===store.currentId); if(!p)return; p.name=pName.value.trim()||'Player'; p.bio=pBio.value.trim(); store.profiles=arr; refreshPlayerSelect(); });
    pPhoto.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ const arr=store.profiles; const p=arr.find(x=>x.id===store.currentId); p.photo=r.result; store.profiles=arr; player.setIcon(avatarIcon(p.photo)); }; r.readAsDataURL(f); });
    function renderInventory(){ const p=currentProfile(); invList.innerHTML=''; (p.inventory||[]).forEach((it,idx)=>{ const el=document.createElement('div'); el.className='chip'; el.innerHTML=`<span>${it.emoji||'ğŸ“¦'}</span><b>${it.name||'Ø¹Ù†ØµØ±'}</b> <button data-i="${idx}">Ø­Ø°Ù</button>`; el.querySelector('button').addEventListener('click',e=>{ const i=+e.target.getAttribute('data-i'); const arr=store.profiles; const me=arr.find(x=>x.id===store.currentId); me.inventory.splice(i,1); store.profiles=arr; renderInventory(); }); invList.appendChild(el); }); }
    document.getElementById('addItem').addEventListener('click', ()=>{ const emoji=(document.getElementById('invEmoji').value||'').trim()||'ğŸ“¦'; const name=(document.getElementById('invName').value||'').trim()||'Ø¹Ù†ØµØ±'; const arr=store.profiles; const p=arr.find(x=>x.id===store.currentId); (p.inventory||(p.inventory=[])).push({emoji,name,at:Date.now()}); store.profiles=arr; document.getElementById('invEmoji').value=''; document.getElementById('invName').value=''; renderInventory(); });

    /* Chat (Ù…Ø®ØªØµØ±) */
    const chatFrom=document.getElementById('chatFrom'); const chatTo=document.getElementById('chatTo'); const chatList=document.getElementById('chatList'); const chatMsg=document.getElementById('chatMsg');
    function refreshChatSelectors(){ const list=store.profiles; chatFrom.innerHTML=''; chatTo.innerHTML=''; list.forEach(p=>{const a=document.createElement('option'); a.value=p.id; a.textContent=p.name||'Ù„Ø§Ø¹Ø¨'; chatFrom.appendChild(a); const b=document.createElement('option'); b.value=p.id; b.textContent=p.name||'Ù„Ø§Ø¹Ø¨'; chatTo.appendChild(b);}); chatFrom.value=store.currentId||list[0].id; const def=list.find(p=>p.id!==chatFrom.value)||list[0]; chatTo.value=def.id; }
    function renderChat(){ const f=chatFrom.value,t=chatTo.value; const msgs=store.chats.filter(m=>(m.from===f&&m.to===t)||(m.from===t&&m.to===f)).sort((a,b)=>a.at-b.at); chatList.innerHTML=''; msgs.forEach(m=>{ const d=document.createElement('div'); d.className='msg '+(m.from===f?'me':'them'); const s=(store.profiles.find(p=>p.id===m.from)||{}).name||'Ù…Ø¬Ù‡ÙˆÙ„'; const time=new Date(m.at).toLocaleTimeString(); d.innerHTML=`<div>${m.text}</div><small>${s} â€¢ ${time}</small>`; chatList.appendChild(d);}); chatList.scrollTop=chatList.scrollHeight; }
    document.getElementById('openChat').addEventListener('click', ()=>{ const o=chatPanel.classList.contains('open'); closePanels(); if(!o){ openPanel(chatPanel); refreshChatSelectors(); renderChat(); }});
    document.getElementById('sendMsg').addEventListener('click', ()=>{ const text=chatMsg.value.trim(); if(!text)return; const from=chatFrom.value,to=chatTo.value; const arr=store.chats; arr.push({id:'m-'+Date.now(),from,to,text,at:Date.now()}); store.chats=arr; chatMsg.value=''; renderChat(); });
    chatMsg.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('sendMsg').click(); } });
    document.getElementById('closeChat').addEventListener('click', ()=>closePanel(chatPanel));
    document.getElementById('closeProfile').addEventListener('click', ()=>closePanel(profilePanel));
    document.getElementById('openProfile').addEventListener('click', ()=>{ const o=profilePanel.classList.contains('open'); closePanels(); if(!o){ openPanel(profilePanel); refreshPlayerSelect(); }});
    map.on('click', closePanels); map.on('dragstart', closePanels);
    document.getElementById('map').addEventListener('pointerdown', closePanels);
  </script>
</body>
</html>
