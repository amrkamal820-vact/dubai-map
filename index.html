<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dubai Map â€“ PWA</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=40"/>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }

    .hud{
      position:fixed; right:10px; top:10px; z-index:1000;
      background:rgba(0,0,0,.55); color:#fff; padding:8px 10px; border-radius:10px;
      font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      pointer-events:none
    }

    #turboToggle{
      position:fixed; left:12px; top:12px; z-index:1002;
      border:0; border-radius:12px; padding:8px 12px; font-weight:700;
      background:rgba(255,213,0,.95); color:#000
    }
    #turboToggle:active{ transform:scale(.96) }

    #gpsBtn{
      position:fixed; left:12px; bottom:12px; z-index:1002;
      width:56px; height:56px; border-radius:50%; border:0;
      background:rgba(0,0,0,.55); color:#fff; font-size:22px; display:grid; place-items:center;
      backdrop-filter:blur(6px)
    }
    #gpsBtn:active{ transform:scale(.96) }

    /* d-pad */
    .pad{
      position:fixed; right:12px; bottom:12px; z-index:1001;
      display:grid; grid-template-columns:56px 56px 56px; grid-template-rows:56px 56px 56px; gap:6px;
      pointer-events:none /* Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ ØªÙ…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    }
    .btn{
      background:rgba(0,0,0,.45); color:#fff; border-radius:14px; display:flex; align-items:center; justify-content:center;
      font-size:18px; backdrop-filter: blur(6px); touch-action:none; pointer-events:auto
    }
    .btn:active{ transform:scale(.97) }
    .hidden{ visibility:hidden }

    /* Ø´ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ */
    .avatar-wrap{ position:relative; width:48px; height:48px; }
    .avatar{ width:48px; height:48px; border-radius:50%; background:#fff center/cover no-repeat;
      border:2px solid #fff; box-shadow:0 0 0 3px rgba(59,130,246,.25), 0 6px 16px rgba(0,0,0,.3);
      transform-origin:center center; transition:transform .06s linear
    }
    .name-tag{
      position:absolute; bottom:52px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.65); color:#fff; font-size:12px; padding:2px 6px; border-radius:8px; white-space:nowrap
    }

    /* Ø§Ù„Ù†ÙˆØ§ÙØ° */
    .panel{
      position:fixed; inset-inline-start:12px; inset-block-start:70px; width:320px; max-width:86vw; z-index:1003;
      background:#111827; color:#fff; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.35);
      display:none; overflow:hidden
    }
    .panel header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0b1220 }
    .panel header h3{ margin:0; font-size:15px }
    .panel header button{ background:#ef4444; color:#fff; border:0; border-radius:8px; padding:4px 8px; font-weight:700 }
    .panel .body{ padding:12px }
    .row{ display:flex; gap:10px; align-items:center }
    .row img{ width:64px; height:64px; border-radius:12px; object-fit:cover; border:2px solid #fff }

    .toolbar{
      position:fixed; left:12px; top:76px; z-index:1002; display:flex; flex-direction:column; gap:8px
    }
    .tool-btn{ border:0; background:#1f2937; color:#fff; padding:8px 10px; border-radius:10px }
    .tool-btn:active{ transform:scale(.96) }

    /* Landmark popup */
    .poi-popup .leaflet-popup-content{ margin:8px 10px; font-size:14px; line-height:1.5; direction:rtl }
    .poi-popup .leaflet-popup-tip, .poi-popup .leaflet-popup-content-wrapper{
      background:#111827; color:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.35)
    }
  </style>
</head>
<body>
  <div class="hud">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ Â· Ø¹Ø¬Ù„Ø© Ø§Ù„Ø²ÙˆÙ… Â· â†‘â†“â†â†’ Ù„Ù„Ø­Ø±ÙƒØ© Â· âš¡ Turbo Â· ğŸ§­ GPS</div>

  <div id="map"></div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <button id="turboToggle">âš¡ Turbo OFF</button>
  <button id="gpsBtn" title="Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ§­</button>

  <!-- Ø£Ø¯ÙˆØ§Øª ÙØªØ­ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„/Ø§Ù„Ø´Ø§Øª -->
  <div class="toolbar">
    <button class="tool-btn" id="openProfile">ğŸ‘¤ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
    <button class="tool-btn" id="openChat">ğŸ’¬ Ø´Ø§Øª</button>
  </div>

  <!-- d-pad -->
  <div class="pad" id="pad">
    <div class="hidden"></div><div class="btn" data-k="ArrowUp">â†‘</div><div class="hidden"></div>
    <div class="btn" data-k="ArrowLeft">â†</div><div class="hidden"></div><div class="btn" data-k="ArrowRight">â†’</div>
    <div class="hidden"></div><div class="btn" data-k="ArrowDown">â†“</div><div class="hidden"></div>
  </div>

  <!-- Panel: Profile -->
  <section class="panel" id="profilePanel">
    <header>
      <h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
      <button data-close="#profilePanel">Ø¥ØºÙ„Ø§Ù‚</button>
    </header>
    <div class="body">
      <div class="row">
        <img id="profileAvatar" src="player-new.png" alt="avatar">
        <div>
          <div><b>Ø§Ù„Ø§Ø³Ù…:</b> Player 1</div>
          <div><b>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</b> 1</div>
          <div><b>Ø§Ù„Ù…Ù‚ØªÙ†ÙŠØ§Øª:</b> Ø³ÙŠØ§Ø±Ø©ØŒ Ù…ÙˆØ¨Ø§ÙŠÙ„</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Panel: Chat -->
  <section class="panel" id="chatPanel">
    <header>
      <h3>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
      <button data-close="#chatPanel">Ø¥ØºÙ„Ø§Ù‚</button>
    </header>
    <div class="body">
      <div id="chatLog" style="max-height:40vh; overflow:auto; background:#0b1220; border-radius:10px; padding:8px"></div>
      <div style="display:flex; gap:6px; margin-top:8px">
        <input id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©â€¦" style="flex:1; padding:8px; border-radius:8px; border:1px solid #374151; background:#111827; color:#fff">
        <button class="tool-btn" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=40"></script>
  <script>
    /* ===== Service Worker ===== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?ver=40').catch(console.warn);
      });
    }

    /* ===== Ø£ØµÙˆÙ„ + ÙƒØ³Ø± ÙƒØ§Ø´ ===== */
    const VER  = 'v=40';
    const BASE = location.hostname.endsWith('github.io') ? '/dubai-map/' : '/';
    const ASSET = (p) => BASE + p + (p.includes('?') ? '&' : '?') + VER;

    /* ===== Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
    const dubai = [25.2048, 55.2708];
    const map = L.map('map', {
      zoomControl:true, dragging:true, scrollWheelZoom:true, tap:false, touchZoom:true, boxZoom:true
    }).setView(dubai, 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap contributors', maxZoom:19
    }).addTo(map);

    /* ===== Ù„Ø§Ø¹Ø¨: ØªØ¯ÙˆÙŠØ± + Ù‡Ø§Ù„Ø© + Ù„Ø§Ø¨Ù„ ===== */
    function avatarDiv(url, name='Player 1'){
      return `
        <div class="avatar-wrap">
          <div class="avatar" id="avatarImg" style="background-image:url('${url}')"></div>
          <div class="name-tag">${name}</div>
        </div>`;
    }
    function avatarIcon(url){ return L.divIcon({ html: avatarDiv(url), className:'', iconSize:[48,48], iconAnchor:[24,24] }); }

    let lat=dubai[0], lng=dubai[1], tLat=lat, tLng=lng;
    const SMOOTH=0.18, WALK=40, SPRINT=180, M_PER_DEG=111000;
    const PAN_OPTS={ animate:true, duration:.15, easeLinearity:.25 };
    let headingDeg=0;

    let player = L.marker([lat,lng], { icon: avatarIcon(ASSET('player-new.png')) }).addTo(map);

    /* Ø±Ø¬ÙˆØ¹ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ */
    try{ const s=JSON.parse(localStorage.getItem('playerPos')); if(Array.isArray(s)){ lat=s[0]; lng=s[1]; tLat=lat; tLng=lng; player.setLatLng(s); map.setView(s);} }catch{}

    /* Ø­ÙØ¸ Ø¯ÙˆØ±ÙŠ */
    let saveAcc=0; function savePos(dt){ saveAcc+=dt; if(saveAcc>=.5){ localStorage.setItem('playerPos', JSON.stringify([lat,lng])); saveAcc=0; } }

    /* Ø­Ø±ÙƒØ© Ù…ØµØ­Ø­Ø© Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª */
    function nudge(dx,dy){ tLng+=dx; tLat+=dy; }
    let held={up:false,down:false,left:false,right:false,sprint:false};
    const turboBtn=document.getElementById('turboToggle');
    function paintTurbo(){ turboBtn.textContent=held.sprint?'âš¡ Turbo ON':'âš¡ Turbo OFF';
      turboBtn.style.background=held.sprint?'rgba(255,80,0,.95)':'rgba(255,213,0,.95)'; }
    turboBtn.addEventListener('click', ()=>{ held.sprint=!held.sprint; paintTurbo(); }); paintTurbo();

    window.addEventListener('keydown',e=>{
      if(e.key==='ArrowUp') held.up=true;
      if(e.key==='ArrowDown') held.down=true;
      if(e.key==='ArrowLeft') held.left=true;
      if(e.key==='ArrowRight') held.right=true;
      if(e.key==='Shift'){ held.sprint=true; paintTurbo(); }
    });
    window.addEventListener('keyup',e=>{
      if(e.key==='ArrowUp') held.up=false;
      if(e.key==='ArrowDown') held.down=false;
      if(e.key==='ArrowLeft') held.left=false;
      if(e.key==='ArrowRight') held.right=false;
      if(e.key==='Shift'){ held.sprint=false; paintTurbo(); }
    });

    const pad=document.getElementById('pad');
    function setHeld(el,val){ const k=el.getAttribute('data-k');
      if(k==='ArrowUp') held.up=val;
      if(k==='ArrowDown') held.down=val;
      if(k==='ArrowLeft') held.left=val;
      if(k==='ArrowRight') held.right=val;
    }
    pad.addEventListener('pointerdown',e=>{ const t=e.target.closest('.btn'); if(!t) return; setHeld(t,true); t.setPointerCapture?.(e.pointerId); });
    pad.addEventListener('pointerup',e=>{ const t=e.target.closest('.btn'); if(!t) return; setHeld(t,false); });

    /* GPS */
    document.getElementById('gpsBtn').addEventListener('click',()=>{
      if(!('geolocation' in navigator)) return alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS');
      const b=document.getElementById('gpsBtn'); b.disabled=true; b.style.opacity=.7;
      navigator.geolocation.getCurrentPosition(pos=>{
        b.disabled=false; b.style.opacity=1;
        const {latitude,longitude,accuracy}=pos.coords;
        tLat=lat=latitude; tLng=lng=longitude; player.setLatLng([lat,lng]); map.setView([lat,lng], Math.max(map.getZoom(),16), {animate:true,duration:.4});
        const c=L.circle([lat,lng],{radius:Math.max(accuracy,25),color:'#3b82f6',fillColor:'#60a5fa',fillOpacity:.2,weight:1}).addTo(map);
        setTimeout(()=>map.removeLayer(c),3000);
      },_=>{ b.disabled=false; b.style.opacity=1; alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    });

    /* Ø§Ù„Ø­Ù„Ù‚Ø© */
    let last=performance.now();
    function tick(now){
      const dt=(now-last)/1000; last=now;
      const speed=(held.sprint?SPRINT:WALK), step=(speed/M_PER_DEG)*dt;
      const vx=(held.right?1:0)-(held.left?1:0);   // ÙŠÙ…ÙŠÙ† Ù…ÙˆØ¬Ø¨ØŒ Ø´Ù…Ø§Ù„ Ø³Ø§Ù„Ø¨ (Ø´Ø±Ù‚/ØºØ±Ø¨)
      const vy=(held.up?1:0)-(held.down?1:0);      // Ø£Ø¹Ù„Ù‰ Ù…ÙˆØ¬Ø¨ØŒ Ø£Ø³ÙÙ„ Ø³Ø§Ù„Ø¨ (Ø´Ù…Ø§Ù„/Ø¬Ù†ÙˆØ¨)
      if(vx||vy){ nudge(vx*step, vy*step); headingDeg = Math.atan2(vy, vx) * 180/Math.PI; }

      const dLat=tLat-lat, dLng=tLng-lng;
      lat+=dLat*SMOOTH; lng+=dLng*SMOOTH;
      const p=[lat,lng];
      player.setLatLng(p); map.panTo(p, PAN_OPTS);

      // Ø¯ÙˆÙ‘Ø± Ø§Ù„ØµÙˆØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
      const img=document.getElementById('avatarImg');
      if(img) img.style.transform = `rotate(${headingDeg}deg)`;

      savePos(dt);
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    /* Ù†ÙˆØ§ÙØ°: Ø¨Ø±ÙˆÙØ§ÙŠÙ„/Ø´Ø§Øª + Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ù„Ù…Ø³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    const profilePanel=document.getElementById('profilePanel');
    const chatPanel=document.getElementById('chatPanel');
    function closePanels(){ profilePanel.style.display='none'; chatPanel.style.display='none'; }
    document.getElementById('openProfile').onclick=()=>{ profilePanel.style.display='block'; chatPanel.style.display='none'; };
    document.getElementById('openChat').onclick=()=>{ chatPanel.style.display='block'; profilePanel.style.display='none'; };
    document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',()=>{ document.querySelector(b.getAttribute('data-close')).style.display='none'; }));
    map.on('click', closePanels); // Ù„Ù…Ø³/ÙƒÙ„ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠÙ‚ÙÙ„ Ø£ÙŠ Ø¨Ø§Ù†Ù„

    // Ø´Ø§Øª Ø¨Ø³ÙŠØ· Ù…Ø­Ù„ÙŠ
    const chatLog=document.getElementById('chatLog'), chatInput=document.getElementById('chatInput'), sendBtn=document.getElementById('sendBtn');
    function addMsg(txt,me=true){ const d=document.createElement('div'); d.style.margin='6px 0'; d.innerHTML = me?`<b>Ø£Ù†Ø§:</b> ${txt}`:`<b>Player 2:</b> ${txt}`; chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight; }
    sendBtn.onclick=()=>{ const t=chatInput.value.trim(); if(!t) return; addMsg(t,true); chatInput.value=''; setTimeout(()=>addMsg('ØªÙ…Ø§Ù… ğŸ‘',false),600); };
    chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendBtn.click(); });

    /* Ù…Ø¹Ø§Ù„Ù… Ø¯Ø¨ÙŠ + ØµÙˆØ± */
    function imgPopup(title, imgUrl){
      return `<div style="display:flex; gap:10px; align-items:center">
        <img src="${imgUrl}" style="width:72px; height:72px; border-radius:10px; object-fit:cover">
        <div><b>${title}</b><br><small>Dubai â€¢ Landmark</small></div>
      </div>`;
    }
    const landmarks = [
      {name:'Burj Khalifa', pos:[25.1972,55.2744], img:'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Burj_Khalifa.jpg/240px-Burj_Khalifa.jpg'},
      {name:'Burj Al Arab', pos:[25.1412,55.1852], img:'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Burj_Al_Arab_and_Jumeirah_Beach_Hotel.jpg/240px-Burj_Al_Arab_and_Jumeirah_Beach_Hotel.jpg'},
      {name:'Museum of the Future', pos:[25.2269,55.2865], img:'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Museum_of_the_Future.jpg/240px-Museum_of_the_Future.jpg'},
      {name:'Dubai Frame', pos:[25.2343,55.3001], img:'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/Dubai_Frame_2018.jpg/240px-Dubai_Frame_2018.jpg'},
      {name:'Palm Jumeirah', pos:[25.1122,55.1389], img:'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Palm_Jumeirah.jpg/240px-Palm_Jumeirah.jpg'}
    ];
    function ico(emoji){ return L.divIcon({ html:
      `<div class="avatar" style="width:44px;height:44px;border-radius:50%;border-color:#222;background:#fff;display:grid;place-items:center;font-size:20px;">${emoji}</div>`,
      className:'', iconSize:[44,44], iconAnchor:[22,22] });
    }
    const gLandmarks=L.layerGroup().addTo(map);
    landmarks.forEach(l=>{
      L.marker(l.pos,{icon:ico('ğŸ“')})
       .addTo(gLandmarks)
       .bindPopup(imgPopup(l.name,l.img), { className:'poi-popup' });
    });
    L.control.layers(null, { "ğŸ“ Dubai Landmarks": gLandmarks }, { collapsed:true, position:'topright' }).addTo(map);
  </script>
</body>
</html>
