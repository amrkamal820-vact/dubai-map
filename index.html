<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dubai Map – PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=7"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud {
      position: fixed; right: 10px; top: 10px; z-index: 1000;
      background: rgba(0,0,0,.55); color: #fff; padding: 8px 10px; border-radius: 10px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; font-size: 14px;
    }

    .pad {
      position: fixed; right: 12px; bottom: 12px; z-index: 1001;
      display: grid; grid-template-columns: 56px 56px 56px; grid-template-rows: 56px 56px 56px;
      gap: 6px; user-select: none;
    }
    .btn {
      background: rgba(0,0,0,.45);
      color: #fff; border-radius: 14px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; backdrop-filter: blur(6px);
      touch-action: none;
    }
    .btn:active { transform: scale(.97); }
    .hidden { visibility: hidden; }

    /* زر Turbo المتحوّل (Toggle) أعلى يسار */
    #turboToggle {
      position: fixed; left: 12px; top: 12px; z-index: 1002;
      border: 0; border-radius: 12px; padding: 8px 12px; font-size: 16px; font-weight: 700;
      color: #000; background: rgba(255,213,0,.95); user-select: none;
    }
    #turboToggle:active { transform: scale(.96); }

    @media (min-width: 900px) { .pad { right: 20px; bottom: 20px; } }
  </style>
</head>
<body>
  <div class="hud">↑↓←→ للتحرّك · كبّر/صغّر باللمس · ⚡ للتيربو (تشغيل/إيقاف)</div>

  <div id="map"></div>

  <!-- زر Toggle Turbo -->
  <button id="turboToggle">⚡ Turbo OFF</button>

  <!-- d-pad للموبايل -->
  <div class="pad" id="pad">
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowUp">↑</div>
    <div class="hidden"></div>

    <div class="btn" data-k="ArrowLeft">←</div>
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowRight">→</div>

    <div class="hidden"></div>
    <div class="btn" data-k="ArrowDown">↓</div>
    <div class="hidden"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=7"></script>
  <script>
    // أجبر تحديث SW عشان تغييرات الاتجاهات/التيربو تظهر فورًا
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?ver=7').then(r => r.update?.()).catch(console.warn);
      });
    }

    // الخريطة
    const dubai = [25.2048, 55.2708];
    const map = L.map('map', { zoomControl: true }).setView(dubai, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    // اللاعب
    const playerIcon = L.icon({ iconUrl: 'player.png', iconSize: [44,44], iconAnchor: [22,22] });
    const player = L.marker(dubai, { draggable:false, icon: playerIcon }).addTo(map);

    // موقع محفوظ
    let lat = dubai[0], lng = dubai[1];
    try {
      const saved = JSON.parse(localStorage.getItem('playerPos'));
      if (Array.isArray(saved)) { lat = saved[0]; lng = saved[1]; player.setLatLng(saved); map.setView(saved); }
    } catch {}

    function move(dx, dy) {
      // dx يؤثر على LNG (يمين/يسار) — dy يؤثر على LAT (فوق/تحت)
      lng += dx;
      lat += dy;
      const p = [lat, lng];
      player.setLatLng(p);
      map.panTo(p, { animate: false });
      localStorage.setItem('playerPos', JSON.stringify(p));
    }

    // سرعات
    const WALK_SPEED_MPS   = 40;    // مشي سريع
    const SPRINT_SPEED_MPS = 180;   // Turbo أسرع بشكل واضح
    const METERS_PER_DEG_LAT = 111000;

    // الحالة
    let held = { up:false, down:false, left:false, right:false, sprint:false };

    // كيبورد
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp')    held.up = true;
      if (e.key === 'ArrowDown')  held.down = true;
      if (e.key === 'ArrowLeft')  held.left = true;
      if (e.key === 'ArrowRight') held.right = true;
      if (e.key === 'Shift')      held.sprint = true;
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp')    held.up = false;
      if (e.key === 'ArrowDown')  held.down = false;
      if (e.key === 'ArrowLeft')  held.left = false;
      if (e.key === 'ArrowRight') held.right = false;
      if (e.key === 'Shift')      held.sprint = false;
    });

    // لمس (d-pad)
    const pad = document.getElementById('pad');
    function setHeldFromTarget(t, val) {
      const k = t.getAttribute('data-k'); if (!k) return;
      if (k === 'ArrowUp')    held.up    = val;
      if (k === 'ArrowDown')  held.down  = val;
      if (k === 'ArrowLeft')  held.left  = val;
      if (k === 'ArrowRight') held.right = val;
    }
    pad.addEventListener('pointerdown', (e) => {
      const t = e.target.closest('.btn'); if (!t) return;
      setHeldFromTarget(t, true);
      t.setPointerCapture?.(e.pointerId);
    });
    pad.addEventListener('pointerup',   (e) => { const t = e.target.closest('.btn'); if (!t) return; setHeldFromTarget(t, false); });
    pad.addEventListener('pointercancel',() => { held = {up:false,down:false,left:false,right:false,sprint:false}; });

    // زر Toggle Turbo (تشغيل/إيقاف)
    const turboBtn = document.getElementById('turboToggle');
    function renderTurbo(){
      turboBtn.textContent = held.sprint ? '⚡ Turbo ON' : '⚡ Turbo OFF';
      turboBtn.style.background = held.sprint ? 'rgba(255,80,0,.95)' : 'rgba(255,213,0,.95)';
    }
    turboBtn.addEventListener('click', () => { held.sprint = !held.sprint; renderTurbo(); });
    renderTurbo();

    // حركة سلسة — الاتجاهات الصحيحة:
    // ↑: يزيد LAT (dy+) ، ↓: يقلل LAT (dy-)
    // →: يزيد LNG (dx+) ، ←: يقلل LNG (dx-)
    let last = performance.now();
    function tick(now) {
      const dt = (now - last) / 1000; last = now;
      const speedMps = held.sprint ? SPRINT_SPEED_MPS : WALK_SPEED_MPS;
      const stepDeg  = (speedMps / METERS_PER_DEG_LAT) * dt;

      // right/left = على محور X (lng) — up/down = على محور Y (lat)
      const vx = (held.right ? 1 : 0) - (held.left ? 1 : 0); // يمين موجب
      const vy = (held.up    ? 1 : 0) - (held.down ? 1 : 0); // فوق موجب

      const dx = vx * stepDeg;
      const dy = vy * stepDeg;

      if (dx || dy) move(dx, dy);
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // نقاط مثال
    [{"name":"Downtown Dubai","pos":[25.1972,55.2744]},
     {"name":"Dubai Marina","pos":[25.08,55.139]},
     {"name":"Deira","pos":[25.2711,55.3075]},
     {"name":"Jumeirah","pos":[25.2028,55.2397]}]
     .forEach(a=>L.circleMarker(a.pos,{radius:6}).addTo(map).bindPopup(a.name));
  </script>
</body>
</html>
