<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dubai Map â€“ PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=12"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud {
      position: fixed; right: 10px; top: 10px; z-index: 1000;
      background: rgba(0,0,0,.55); color: #fff; padding: 8px 10px; border-radius: 10px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; font-size: 14px;
    }

    /* d-pad Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ† */
    .pad {
      position: fixed; right: 12px; bottom: 12px; z-index: 1001;
      display: grid; grid-template-columns: 56px 56px 56px; grid-template-rows: 56px 56px 56px;
      gap: 6px; user-select: none;
    }
    .btn {
      background: rgba(0,0,0,.45);
      color: #fff; border-radius: 14px; display: flex; align-items: center; justify-content: center;
      font-size: 18px; backdrop-filter: blur(6px);
      touch-action: none;
    }
    .btn:active { transform: scale(.97); }
    .hidden { visibility: hidden; }

    /* Ø²Ø± Turbo (Toggle) Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± */
    #turboToggle {
      position: fixed; left: 12px; top: 12px; z-index: 1002;
      border: 0; border-radius: 12px; padding: 8px 12px; font-size: 16px; font-weight: 700;
      color: #000; background: rgba(255,213,0,.95); user-select: none;
    }
    #turboToggle:active { transform: scale(.96); }

    /* Ø²Ø± GPS Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± */
    #gpsBtn {
      position: fixed; left: 12px; bottom: 12px; z-index: 1002;
      width: 56px; height: 56px; border-radius: 50%; border: 0;
      background: rgba(0,0,0,.55); color: #fff; font-size: 22px; font-weight: 700;
      display: grid; place-items: center; user-select: none;
      backdrop-filter: blur(6px);
    }
    #gpsBtn:active { transform: scale(.96); }

    /* ÙÙ‚Ø§Ø¹Ø© Ø¯Ø±Ø¯Ø´Ø© */
    .poi-popup .leaflet-popup-content { margin: 8px 10px; font-size: 14px; line-height: 1.5; direction: rtl; }
    .poi-popup .leaflet-popup-tip, .poi-popup .leaflet-popup-content-wrapper {
      background: #111827; color: #fff; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }

    @media (min-width: 900px) {
      .pad { right: 20px; bottom: 20px; }
      #gpsBtn { left: 20px; bottom: 20px; }
    }
  </style>
</head>
<body>
  <div class="hud">â†‘â†“â†â†’ Ù„Ù„ØªØ­Ø±Ù‘Ùƒ Â· ÙƒØ¨Ù‘Ø±/ØµØºÙ‘Ø± Ø¨Ø§Ù„Ù„Ù…Ø³ Â· âš¡ Ù„Ù„ØªÙŠØ±Ø¨Ùˆ (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù) Â· ğŸ§­ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</div>

  <div id="map"></div>

  <!-- Ø²Ø± Toggle Turbo -->
  <button id="turboToggle">âš¡ Turbo OFF</button>

  <!-- Ø²Ø± GPS -->
  <button id="gpsBtn" title="Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ§­</button>

  <!-- d-pad Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (â†‘ / â† / â†’ / â†“) -->
  <div class="pad" id="pad">
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowUp">â†‘</div>
    <div class="hidden"></div>

    <div class="btn" data-k="ArrowLeft">â†</div>
    <div class="hidden"></div>
    <div class="btn" data-k="ArrowRight">â†’</div>

    <div class="hidden"></div>
    <div class="btn" data-k="ArrowDown">â†“</div>
    <div class="hidden"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=12"></script>
  <script>
    // Ø¥Ø¬Ø¨Ø§Ø± ØªØ­Ø¯ÙŠØ« SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?ver=12').then(r => r.update?.()).catch(console.warn);
      });
    }

    // Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const dubai = [25.2048, 55.2708];
    const map = L.map('map', { zoomControl: true }).setView(dubai, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    // Ø§Ù„Ù„Ø§Ø¹Ø¨
    const playerIcon = L.icon({ iconUrl: 'player.png', iconSize: [44,44], iconAnchor: [22,22] });
    const player = L.marker(dubai, { draggable:false, icon: playerIcon }).addTo(map);

    // Ù…ÙˆØ¶Ø¹ Ø­Ø§Ù„ÙŠ + Ù‡Ø¯Ù (Ù„Ù„Ø¥ÙŠÙ€Ø²Ù†Ø¬)
    let lat = dubai[0], lng = dubai[1];
    let tLat = lat,   tLng = lng; // targets

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹
    try {
      const saved = JSON.parse(localStorage.getItem('playerPos'));
      if (Array.isArray(saved)) { lat = saved[0]; lng = saved[1]; tLat = lat; tLng = lng; player.setLatLng(saved); map.setView(saved); }
    } catch {}

    // Ø­ÙØ¸ Ù…ØªØ¨Ø§Ø¹Ø¯
    let saveAccum = 0;
    function savePos(dt){
      saveAccum += dt;
      if (saveAccum >= 0.5) {
        localStorage.setItem('playerPos', JSON.stringify([lat, lng]));
        saveAccum = 0;
      }
    }

    // Ø§Ù„Ø­Ø±ÙƒØ©: Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‡Ø¯Ù ÙÙ‚Ø·
    function nudgeTarget(dx, dy) {
      tLng += dx;  // dx â†’ lng (ÙŠÙ…ÙŠÙ†/ÙŠØ³Ø§Ø±)
      tLat += dy;  // dy â†’ lat (ÙÙˆÙ‚/ØªØ­Øª)
    }

    // Ø³Ø±Ø¹Ø§Øª + Ø³Ù…ÙˆØ«
    const WALK_SPEED_MPS   = 40;
    const SPRINT_SPEED_MPS = 180;
    const METERS_PER_DEG_LAT = 111000;
    const SMOOTH = 0.18;
    const PAN_OPTS = { animate: true, duration: 0.15, easeLinearity: 0.25 };

    // Ø§Ù„Ø­Ø§Ù„Ø© + Toggle Turbo
    let held = { up:false, down:false, left:false, right:false, sprint:false };
    const turboBtn = document.getElementById('turboToggle');
    function renderTurbo(){
      turboBtn.textContent = held.sprint ? 'âš¡ Turbo ON' : 'âš¡ Turbo OFF';
      turboBtn.style.background = held.sprint ? 'rgba(255,80,0,.95)' : 'rgba(255,213,0,.95)';
    }
    turboBtn.addEventListener('click', () => { held.sprint = !held.sprint; renderTurbo(); });
    renderTurbo();

    // ÙƒÙŠØ¨ÙˆØ±Ø¯
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp')    held.up = true;
      if (e.key === 'ArrowDown')  held.down = true;
      if (e.key === 'ArrowLeft')  held.left = true;
      if (e.key === 'ArrowRight') held.right = true;
      if (e.key === 'Shift')      { held.sprint = true; renderTurbo(); }
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp')    held.up = false;
      if (e.key === 'ArrowDown')  held.down = false;
      if (e.key === 'ArrowLeft')  held.left = false;
      if (e.key === 'ArrowRight') held.right = false;
      if (e.key === 'Shift')      { held.sprint = false; renderTurbo(); }
    });

    // Ù„Ù…Ø³ (d-pad)
    const pad = document.getElementById('pad');
    function setHeldFromTarget(t, val) {
      const k = t.getAttribute('data-k'); if (!k) return;
      if (k === 'ArrowUp')    held.up    = val;
      if (k === 'ArrowDown')  held.down  = val;
      if (k === 'ArrowLeft')  held.left  = val;
      if (k === 'ArrowRight') held.right = val;
    }
    pad.addEventListener('pointerdown', (e) => {
      const t = e.target.closest('.btn'); if (!t) return;
      setHeldFromTarget(t, true);
      t.setPointerCapture?.(e.pointerId);
    });
    pad.addEventListener('pointerup',   (e) => { const t = e.target.closest('.btn'); if (!t) return; setHeldFromTarget(t, false); });
    pad.addEventListener('pointercancel',() => { held = {up:false,down:false,left:false,right:false,sprint:held.sprint}; });

    // === Ù†Ù‚Ø§Ø· Ø§Ù‡ØªÙ…Ø§Ù… + ÙÙ‚Ø§Ø¹Ø© Ø¯Ø±Ø¯Ø´Ø© ===
    const pois = [
      { name: 'Dubai Mall',     pos: [25.1975, 55.2790],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Mall</b> ğŸ›ï¸' },
      { name: 'Burj Khalifa',   pos: [25.1972, 55.2744],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Burj Khalifa</b> ğŸ—¼' },
      { name: 'Marina Walk',    pos: [25.0797, 55.1400],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Marina Walk</b> ğŸŒŠ' },
      { name: 'DXB T3',         pos: [25.2487, 55.3526],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Intâ€™l Airport â€“ T3</b> âœˆï¸' },
      { name: 'Deira City Ctr', pos: [25.2532, 55.3349],   msg: 'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Deira City Centre</b> ğŸ›’' },
    ];
    pois.forEach(p => L.circleMarker(p.pos, { radius: 6 }).addTo(map).bindPopup(p.name));

    function distMeters(aLat,aLng,bLat,bLng){
      const R=6371000, toRad=(d)=>d*Math.PI/180;
      const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const A=s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(A)));
    }

    const NEAR = 250;
    let activePOI = null, popupTimer = null;
    const cooldown = {};
    function playDing() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880;
        g.gain.value = 0.001; o.connect(g).connect(ctx.destination); o.start();
        g.gain.exponentialRampToValueAtTime(0.2,  ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime + 0.18);
        o.stop(ctx.currentTime + 0.2);
      } catch(e){}
    }
    function openPOI(p) {
      activePOI = p.name;
      player.bindPopup(p.msg, { offset:[0,-28], autoPan:false, closeButton:false, className:'poi-popup' }).openPopup();
      playDing();
      if (popupTimer) clearTimeout(popupTimer);
      popupTimer = setTimeout(() => {
        player.closePopup(); activePOI = null; cooldown[p.name] = performance.now() + 3000;
      }, 4000);
    }
    function updatePOIPopup() {
      let found = null;
      for (const p of pois) {
        if (distMeters(lat, lng, p.pos[0], p.pos[1]) <= NEAR) { found = p; break; }
      }
      const now = performance.now();
      if (found) {
        const cd = cooldown[found.name] || 0;
        if (!activePOI && now > cd) openPOI(found);
      } else {
        if (activePOI) { player.closePopup(); activePOI = null; }
        if (popupTimer) { clearTimeout(popupTimer); popupTimer = null; }
      }
    }

    // Ø²Ø± GPS â€” ÙŠØ­Ø±ÙƒÙƒ Ù„Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    const gpsBtn = document.getElementById('gpsBtn');
    gpsBtn.addEventListener('click', () => {
      if (!('geolocation' in navigator)) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (GPS).');
        return;
      }
      gpsBtn.disabled = true; gpsBtn.style.opacity = 0.7;
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          gpsBtn.disabled = false; gpsBtn.style.opacity = 1;
          const { latitude, longitude, accuracy } = pos.coords;

          // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‡Ø¯Ù ÙˆØ­Ø±Ù‘Ùƒ Ø¨Ø§Ù†Ø³ÙŠØ§Ø¨ÙŠØ©
          tLat = latitude; tLng = longitude;
          lat  = latitude; lng  = longitude; // Ù†Ù‚ÙØ² ÙÙˆØ±Ù‹Ø§ Ø¹Ø´Ø§Ù† ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§Ø¶Ø­Ø©
          player.setLatLng([lat,lng]);
          map.setView([lat, lng], Math.max(map.getZoom(), 16), { animate: true, duration: 0.4 });

          // ÙˆÙ…ÙŠØ¶ Ø¯Ø§Ø¦Ø±Ø© Ø¯Ù‚Ù‘Ø© Ù„Ø«ÙˆØ§Ù†ÙŠ
          const circle = L.circle([lat,lng], { radius: Math.max(accuracy, 25), color:'#3b82f6', fillColor:'#60a5fa', fillOpacity:0.2, weight:1 }).addTo(map);
          setTimeout(()=> map.removeLayer(circle), 4000);
        },
        (err) => {
          gpsBtn.disabled = false; gpsBtn.style.opacity = 1;
          alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' + (err.message || err.code));
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
      );
    });

    // Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©: Ø³Ù…ÙˆØ« Ø¥ÙŠÙ€Ø²Ù†Ø¬ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù
    let last = performance.now();
    function tick(now) {
      const dt = (now - last) / 1000; last = now;

      // Ø³Ø±Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„ØªÙŠØ±Ø¨Ùˆ
      const speedMps = held.sprint ? SPRINT_SPEED_MPS : WALK_SPEED_MPS;
      const stepDeg  = (speedMps / METERS_PER_DEG_LAT) * dt;

      // Ø§ØªØ¬Ø§Ù‡ Ù…Ø·Ù„ÙˆØ¨ â†’ Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‡Ø¯Ù
      const vx = (held.right ? 1 : 0) - (held.left ? 1 : 0); // ÙŠÙ…ÙŠÙ† +
      const vy = (held.up    ? 1 : 0) - (held.down ? 1 : 0); // ÙÙˆÙ‚ +
      if (vx || vy) nudgeTarget(vx * stepDeg, vy * stepDeg);

      // Ø­Ø±ÙƒØ© Ø§Ù†Ø²Ù„Ø§Ù‚ÙŠØ© Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù (lerp)
      const dLat = tLat - lat;
      const dLng = tLng - lng;
      lat += dLat * SMOOTH;
      lng += dLng * SMOOTH;

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø±ÙƒØ± ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø©
      const p = [lat, lng];
      player.setLatLng(p);
      map.panTo(p, PAN_OPTS);

      savePos(dt);
      updatePOIPopup();
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ
    updatePOIPopup();
  </script>
</body>
</html>
