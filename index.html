<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dubai Map â€“ PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=30"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud {
      position: fixed; right: 10px; top: 10px; z-index: 1000;
      background: rgba(0,0,0,.55); color: #fff; padding: 8px 10px; border-radius: 10px;
      font: 14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      pointer-events: none;
    }

    /* Ø£Ø²Ø±Ø§Ø± */
    #turboToggle{
      position:fixed; left:12px; top:12px; z-index:1002;
      border:0; border-radius:12px; padding:8px 12px; font-size:16px; font-weight:700;
      color:#000; background:rgba(255,213,0,.95); user-select:none;
    }
    #turboToggle:active{ transform:scale(.96); }

    #gpsBtn{
      position:fixed; left:12px; bottom:12px; z-index:1002;
      width:56px; height:56px; border-radius:50%; border:0; background:rgba(0,0,0,.55);
      color:#fff; font-size:22px; font-weight:700; display:grid; place-items:center; user-select:none; backdrop-filter:blur(6px);
    }
    #gpsBtn:active{ transform:scale(.96); }

    /* d-pad */
    .pad {
      position: fixed; right: 12px; bottom: 12px; z-index: 1001;
      display: grid; grid-template-columns: 56px 56px 56px; grid-template-rows: 56px 56px 56px;
      gap: 6px; user-select: none;
      pointer-events: none; /* Ù„Ø§ ØªÙ…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    }
    .btn {
      background: rgba(0,0,0,.45); color:#fff; border-radius:14px;
      display:flex; align-items:center; justify-content:center; font-size:18px; backdrop-filter: blur(6px);
      touch-action:none; pointer-events: auto;
    }
    .btn:active{ transform: scale(.97); }
    .hidden{ visibility:hidden; }

    /* Ø´ÙƒÙ„ Ø§Ù„Ø£ÙØ§ØªØ§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ */
    .avatar-icon {
      width:44px; height:44px; border-radius:50%; overflow:hidden; border:2px solid #ffffffcc;
      box-shadow:0 2px 10px rgba(0,0,0,.25);
      background:#fff center/cover no-repeat;
    }

    /* Popup Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù„Ù… */
    .poi-popup .leaflet-popup-content{ margin:8px 10px; font-size:14px; line-height:1.5; direction:rtl; }
    .poi-popup .leaflet-popup-tip, .poi-popup .leaflet-popup-content-wrapper{
      background:#111827; color:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <div class="hud">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ Â· Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„Ø²ÙˆÙ… Â· â†‘â†“â†â†’ Ù„Ù„Ø­Ø±ÙƒØ© Â· âš¡ Turbo Â· ğŸ§­ GPS</div>

  <div id="map"></div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰/Ø£Ø³ÙÙ„ -->
  <button id="turboToggle">âš¡ Turbo OFF</button>
  <button id="gpsBtn" title="Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ§­</button>

  <!-- d-pad -->
  <div class="pad" id="pad">
    <div class="hidden"></div><div class="btn" data-k="ArrowUp">â†‘</div><div class="hidden"></div>
    <div class="btn" data-k="ArrowLeft">â†</div><div class="hidden"></div><div class="btn" data-k="ArrowRight">â†’</div>
    <div class="hidden"></div><div class="btn" data-k="ArrowDown">â†“</div><div class="hidden"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=30"></script>
  <script>
    /* ===== Service Worker ===== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?ver=30').catch(console.warn);
      });
    }

    /* ===== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ + ÙƒØ³Ø± Ø§Ù„ÙƒØ§Ø´ ===== */
    const VER  = 'v=30'; // Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ø±Ù‚Ù… Ù„Ùˆ ØºÙŠÙ‘Ø±Øª Ø§Ù„ØµÙˆØ±Ø©
    const BASE = location.hostname.endsWith('github.io') ? '/dubai-map/' : '/';
    const ASSET = (p) => BASE + p + (p.includes('?') ? '&' : '?') + VER;

    /* ===== Map ===== */
    const dubai = [25.2048, 55.2708];
    const map = L.map('map', {
      zoomControl: true, dragging: true, scrollWheelZoom: true, tap: false
    }).setView(dubai, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    /* ===== Player icon (player-new.png Ù…Ù† Ø§Ù„Ø¬Ø°Ø±) ===== */
    function avatarIcon(url){
      const u = url || ASSET('player-new.png'); // â† ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„ØµÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø¬Ø°Ø±
      return L.divIcon({
        html:`<div class="avatar-icon" style="background-image:url('${u}')"></div>`,
        className:'', iconSize:[44,44], iconAnchor:[22,22]
      });
    }

    /* ===== Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù„Ø³Ø© ===== */
    let lat = dubai[0], lng = dubai[1], tLat = lat, tLng = lng;
    const SMOOTH = 0.18;
    const WALK_SPEED_MPS = 40, SPRINT_SPEED_MPS = 180, METERS_PER_DEG_LAT = 111000;
    const PAN_OPTS = { animate:true, duration:0.15, easeLinearity:0.25 };

    let player = L.marker([lat,lng], { icon: avatarIcon() }).addTo(map);

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹
    try { const s=JSON.parse(localStorage.getItem('playerPos')); if(Array.isArray(s)){ lat=s[0]; lng=s[1]; tLat=lat; tLng=lng; player.setLatLng(s); map.setView(s);} } catch {}
    let saveAccum=0; function savePos(dt){ saveAccum+=dt; if(saveAccum>=0.5){ localStorage.setItem('playerPos', JSON.stringify([lat,lng])); saveAccum=0; } }

    function nudgeTarget(dx,dy){ tLng += dx; tLat += dy; }

    let held = { up:false, down:false, left:false, right:false, sprint:false };
    const turboBtn = document.getElementById('turboToggle');
    function renderTurbo(){ turboBtn.textContent = held.sprint ? 'âš¡ Turbo ON' : 'âš¡ Turbo OFF';
      turboBtn.style.background = held.sprint ? 'rgba(255,80,0,.95)' : 'rgba(255,213,0,.95)'; }
    turboBtn.addEventListener('click', ()=>{ held.sprint=!held.sprint; renderTurbo(); }); renderTurbo();

    window.addEventListener('keydown', (e)=>{
      if (e.key==='ArrowUp') held.up=true;
      if (e.key==='ArrowDown') held.down=true;
      if (e.key==='ArrowLeft') held.left=true;
      if (e.key==='ArrowRight') held.right=true;
      if (e.key==='Shift'){ held.sprint=true; renderTurbo(); }
    });
    window.addEventListener('keyup', (e)=>{
      if (e.key==='ArrowUp') held.up=false;
      if (e.key==='ArrowDown') held.down=false;
      if (e.key==='ArrowLeft') held.left=false;
      if (e.key==='ArrowRight') held.right=false;
      if (e.key==='Shift'){ held.sprint=false; renderTurbo(); }
    });

    const pad = document.getElementById('pad');
    function setHeldFromTarget(t,val){ const k=t.getAttribute('data-k'); if(!k)return;
      if(k==='ArrowUp')held.up=val; if(k==='ArrowDown')held.down=val; if(k==='ArrowLeft')held.left=val; if(k==='ArrowRight')held.right=val; }
    pad.addEventListener('pointerdown',e=>{ const t=e.target.closest('.btn'); if(!t)return; setHeldFromTarget(t,true); t.setPointerCapture?.(e.pointerId); });
    pad.addEventListener('pointerup',e=>{ const t=e.target.closest('.btn'); if(!t)return; setHeldFromTarget(t,false); });
    pad.addEventListener('pointercancel',()=>{ held={up:false,down:false,left:false,right:false,sprint:held.sprint}; });

    /* ===== GPS ===== */
    document.getElementById('gpsBtn').addEventListener('click', ()=>{
      if(!('geolocation' in navigator)){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS'); return; }
      const btn=document.getElementById('gpsBtn'); btn.disabled=true; btn.style.opacity=.7;
      navigator.geolocation.getCurrentPosition(pos=>{
        btn.disabled=false; btn.style.opacity=1;
        const { latitude, longitude, accuracy } = pos.coords;
        tLat=latitude; tLng=longitude; lat=latitude; lng=longitude;
        player.setLatLng([lat,lng]); map.setView([lat,lng], Math.max(map.getZoom(),16), {animate:true,duration:.4});
        const circle=L.circle([lat,lng],{radius:Math.max(accuracy,25),color:'#3b82f6',fillColor:'#60a5fa',fillOpacity:.2,weight:1}).addTo(map);
        setTimeout(()=>map.removeLayer(circle),4000);
      }, err=>{ btn.disabled=false; btn.style.opacity=1; alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: '+(err.message||err.code)); }, {enableHighAccuracy:true, timeout:10000, maximumAge:300000});
    });

    /* ===== Ù…Ø¹Ø§Ù„Ù… Ø£Ø³Ø§Ø³ÙŠØ© ===== */
    function ico(emoji){ return L.divIcon({ html:`<div class="avatar-icon" style="border-color:#222;background:#fff;font-size:20px;display:grid;place-items:center;"><span>${emoji}</span></div>`, className:'', iconSize:[44,44], iconAnchor:[22,22] }); }
    const gLandmarks = L.layerGroup().addTo(map);
    [
      {name:'Burj Khalifa',        pos:[25.1972,55.2744], emoji:'ğŸ—¼'},
      {name:'Burj Al Arab',        pos:[25.1412,55.1852], emoji:'ğŸ¨'},
      {name:'Museum of the Future',pos:[25.2269,55.2865], emoji:'ğŸ›ï¸'},
      {name:'Dubai Frame',         pos:[25.2343,55.3001], emoji:'ğŸ–¼ï¸'},
      {name:'Palm Jumeirah',       pos:[25.1122,55.1389], emoji:'ğŸŒ´'}
    ].forEach(p=>{
      L.marker(p.pos,{icon:ico(p.emoji)}).addTo(gLandmarks).bindPopup(`<b>${p.name}</b>`);
    });
    L.control.layers(null, { "ğŸ›ï¸ Landmarks": gLandmarks }, { collapsed:true, position:'topright' }).addTo(map);

    /* ===== ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ù… (250Ù…) ===== */
    function distMeters(aLat,aLng,bLat,bLng){ const R=6371000,toRad=d=>d*Math.PI/180; const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2); const A=s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2; return 2*R*Math.asin(Math.min(1,Math.sqrt(A))); }
    const NEAR=250; let activePOI=null, popupTimer=null; const cooldown={};
    function ding(){ try{ const c=new (window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(),g=c.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.001; o.connect(g).connect(c.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.2,c.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.18); o.stop(c.currentTime+0.2);}catch(e){} }
    const corePOIs = [
      { name:'Dubai Mall', pos:[25.1975,55.2790], msg:'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Dubai Mall</b> ğŸ›ï¸' },
      { name:'Burj Khalifa', pos:[25.1972,55.2744], msg:'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Burj Khalifa</b> ğŸ—¼' },
      { name:'Burj Al Arab', pos:[25.1412,55.1852], msg:'Ø£Ù†Øª Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† <b>Burj Al Arab</b> ğŸ¨' },
    ];
    function openPOI(p){ activePOI=p.name; player.bindPopup(p.msg,{offset:[0,-28],autoPan:false,closeButton:false,className:'poi-popup'}).openPopup(); ding();
      if(popupTimer)clearTimeout(popupTimer); popupTimer=setTimeout(()=>{ player.closePopup(); activePOI=null; cooldown[p.name]=performance.now()+3000; },4000); }
    function updatePOIPopup(){ let found=null; for(const p of corePOIs){ if(distMeters(lat,lng,p.pos[0],p.pos[1])<=NEAR){ found=p; break; } }
      const now=performance.now(); if(found){ const cd=cooldown[found.name]||0; if(!activePOI && now>cd) openPOI(found); }
      else{ if(activePOI){ player.closePopup(); activePOI=null; } if(popupTimer){ clearTimeout(popupTimer); popupTimer=null; } } }

    /* ===== Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø­Ø±ÙƒØ© Ø³Ù„Ø³Ø©) ===== */
    let last=performance.now();
    function tick(now){
      const dt=(now-last)/1000; last=now;
      const speedMps = held.sprint ? SPRINT_SPEED_MPS : WALK_SPEED_MPS;
      const stepDeg  = (speedMps / METERS_PER_DEG_LAT) * dt;
      const vx=(held.right?1:0)-(held.left?1:0);
      const vy=(held.up?1:0)-(held.down?1:0);
      if(vx||vy) nudgeTarget(vx*stepDeg, vy*stepDeg);

      const dLat=tLat-lat, dLng=tLng-lng;
      lat+=dLat*SMOOTH; lng+=dLng*SMOOTH;

      const p=[lat,lng];
      player.setLatLng(p);
      map.panTo(p, PAN_OPTS);

      savePos(dt);
      updatePOIPopup();
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  </script>
</body>
</html>
